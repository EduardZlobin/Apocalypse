<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Apocalypse ‚Äî Daily Flame</title>

  <style>
    :root{
      --bg0:#070812;
      --bg1:#0b0f1f;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.09);
      --txt:rgba(255,255,255,.92);
      --mut:rgba(255,255,255,.62);
      --bad:#ff5a6b;
      --ok:#6dffb3;
      --ring:rgba(255,255,255,.12);
      --ring2:rgba(255,255,255,.20);
      --shadow: 0 20px 80px rgba(0,0,0,.55);
      --glass: blur(14px) saturate(120%);
      --radius: 18px;
      --btn: rgba(255,255,255,.08);
      --btnh: rgba(255,255,255,.12);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(120,80,255,.25), transparent 55%),
        radial-gradient(700px 600px at 80% 20%, rgba(50,180,255,.18), transparent 55%),
        radial-gradient(800px 700px at 50% 80%, rgba(255,120,80,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
      overflow-x:hidden;
    }

    .wrap{max-width:1080px; margin:0 auto; padding:18px 18px 60px;}
    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 12px;
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:var(--radius);
      backdrop-filter: var(--glass);
      box-shadow: var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .dot{
      width:12px; height:12px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.2));
      box-shadow: 0 0 24px rgba(160,120,255,.45);
    }
    .title{font-weight:800; letter-spacing:.4px}
    .subtitle{color:var(--mut); font-size:12px; margin-top:2px}

    .btn{
      border:1px solid var(--ring);
      background:var(--btn);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.15s;
      backdrop-filter: var(--glass);
    }
    .btn:hover{background:var(--btnh); transform: translateY(-1px)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}

    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:18px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .panel{
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:var(--radius);
      padding:16px;
      backdrop-filter: var(--glass);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }

    /* FIRE CORE */
    .coreWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      min-height: 460px;
      gap:14px;
      position:relative;
    }

    .ring{
      position:absolute;
      width:520px; height:520px;
      border-radius:50%;
      border:1px solid var(--ring);
      filter: blur(.2px);
      opacity:.55;
      animation: spin 18s linear infinite;
    }
    .ring2{
      position:absolute;
      width:420px; height:420px;
      border-radius:50%;
      border:1px dashed var(--ring2);
      opacity:.35;
      animation: spin 28s linear reverse infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .fireBtn{
      width:240px; height:240px;
      border-radius:50%;
      border:1px solid var(--ring2);
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.22), rgba(255,255,255,.06) 55%, rgba(0,0,0,.25));
      box-shadow: 0 10px 70px rgba(0,0,0,.55), 0 0 120px rgba(255,120,80,.22);
      cursor:pointer;
      display:grid;
      place-items:center;
      position:relative;
      user-select:none;
      transition:.16s;
      backdrop-filter: var(--glass);
    }
    .fireBtn:hover{transform: translateY(-2px) scale(1.01)}
    .fireBtn:active{transform: translateY(0px) scale(.99)}
    .fireBtn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    .emoji{
      font-size:78px;
      filter: drop-shadow(0 10px 24px rgba(0,0,0,.55));
      transform: translateY(-6px);
      animation: flicker 2.8s ease-in-out infinite;
    }
    @keyframes flicker{
      0%,100%{transform: translateY(-6px) scale(1)}
      50%{transform: translateY(-10px) scale(1.02)}
    }

    .inv{
      display:flex; gap:12px; align-items:center; justify-content:center;
      margin-top:4px;
    }

    .invBtn{
      width:74px; height:74px;
      border-radius:50%;
      border:1px solid var(--ring);
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.18), rgba(255,255,255,.06) 60%);
      display:grid;
      place-items:center;
      cursor:pointer;
      position:relative;
      transition:.16s;
      backdrop-filter: var(--glass);
    }
    .invBtn:hover{transform: translateY(-2px)}
    .invBtn:active{transform: translateY(0px)}
    .invBtn:disabled{opacity:.45; cursor:not-allowed; transform:none}

    .badge{
      position:absolute;
      bottom:-6px; right:-6px;
      min-width:26px; height:26px;
      border-radius:999px;
      padding:0 8px;
      display:flex; align-items:center; justify-content:center;
      font-size:12px;
      background:rgba(0,0,0,.35);
      border:1px solid var(--ring);
      color:var(--txt);
      backdrop-filter: var(--glass);
    }

    .meta{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:center;
      color:var(--mut);
      font-size:13px;
      margin-top:8px;
      text-align:center;
    }

    .line{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.14), transparent);
      margin:12px 0;
    }

    .small{font-size:12px; color:var(--mut)}
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--ring);
      background: rgba(255,255,255,.05);
      backdrop-filter: var(--glass);
      font-size:12px;
      color:var(--mut);
    }

    .log{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:520px;
      overflow:auto;
      padding-right:6px;
    }
    .logItem{
      border:1px solid var(--ring);
      background:rgba(255,255,255,.04);
      border-radius:14px;
      padding:10px 12px;
    }
    .logTop{display:flex; justify-content:space-between; gap:10px; align-items:center}
    .logType{font-weight:700}
    .logTime{font-size:12px; color:var(--mut)}
    .logBody{margin-top:6px; color:var(--mut); font-size:13px}

    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--ring);
      background:rgba(255,255,255,.04);
      color:var(--mut);
      min-height:42px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .status b{color:var(--txt)}
    .pillOk{color:var(--ok)}
    .pillBad{color:var(--bad)}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Apocalypse / Daily Flame</div>
          <div class="subtitle">–û–≥–æ–Ω—å –æ–±—â–∏–π. –ú–∏—Ä –¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ –≤–∞—à–µ–π –∑–∞–±—ã–≤—á–∏–≤–æ—Å—Ç–∏.</div>
        </div>
      </div>

      <div class="btnRow">
        <button class="btn" id="btnLogin">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord</button>
        <button class="btn" id="btnLogout" style="display:none;">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="coreWrap">
          <div class="ring"></div>
          <div class="ring2"></div>

          <button class="fireBtn" id="btnFire" disabled title="–ü–æ–¥–∫–∏–Ω—É—Ç—å –¥—Ä–æ–≤–∞ (+24—á, –∫—É–ª–¥–∞—É–Ω 20—á)">
            <div class="emoji">üî•</div>
          </button>

          <div class="inv">
            <button class="invBtn" id="btnCoal" disabled title="–£–≥–æ–ª—å: +30—á (–±–µ–∑ –∫—É–ª–¥–∞—É–Ω–∞)">
              <div style="font-size:28px; filter: drop-shadow(0 8px 16px rgba(0,0,0,.55));">ü™®</div>
              <div class="badge" id="coalCount">0</div>
            </button>

            <button class="invBtn" id="btnFuel" disabled title="–¢–æ–ø–ª–∏–≤–æ: –∑–∞–º–µ–¥–ª—è–µ—Ç –≥–æ—Ä–µ–Ω–∏–µ x0.5 –Ω–∞ 24—á">
              <div style="font-size:28px; filter: drop-shadow(0 8px 16px rgba(0,0,0,.55));">üß™</div>
              <div class="badge" id="fuelCount">0</div>
            </button>
          </div>

          <div class="meta">
            <span>–û—Å—Ç–∞–ª–æ—Å—å: <b id="remainText">‚Äî</b></span>
            <span>‚Ä¢</span>
            <span>–°–∫–æ—Ä–æ—Å—Ç—å: <b id="burnText">‚Äî</b></span>
            <span>‚Ä¢</span>
            <span>–≠—Ñ—Ñ–µ–∫—Ç –¥–æ: <b id="untilText">‚Äî</b></span>
          </div>

          <div class="status">
            <div>–°—Ç–∞—Ç—É—Å: <b id="statusText">–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</b></div>
            <div class="small" id="whoText">‚Äî</div>
          </div>

          <div class="line"></div>

          <div class="kpi">
            <div class="chip" id="chipUser">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ‚Äî</div>
            <div class="chip" id="chipCooldown">–ö—É–ª–¥–∞—É–Ω: ‚Äî</div>
            <div class="chip" id="chipStreak">–°—Ç—Ä–∏–∫: ‚Äî</div>
          </div>

          <div class="small" style="margin-top:10px; text-align:center">
            –ü–æ–¥—Å–∫–∞–∑–∫–∞: –µ—Å–ª–∏ –æ–≥–æ–Ω—å –ø–æ—Ç—É—Ö–Ω–µ—Ç ‚Äî –±—É–¥–µ—Ç <b style="color:var(--bad)">CATASTROPHE</b>. –ò —ç—Ç–æ –Ω–µ –º–µ—Ç–∞—Ñ–æ—Ä–∞, —ç—Ç–æ –∫–∞–Ω–æ–Ω.
          </div>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px;">
          <div>
            <div style="font-weight:800; font-size:16px;">–ò—Å—Ç–æ—Ä–∏—è / –õ–æ–≥–∏</div>
            <div class="small">–ü–æ–∫–∞ –±–µ–∑ –≥—Ä–∞—Ñ–∏–∫–∞ ‚Äî –ª–æ–≥ —É–∂–µ –≥–æ—Ç–æ–≤–∏—Ç ‚Äú–ø–∏–∫–∏ –∏ —è–º—ã‚Äù.</div>
          </div>
          <button class="btn" id="btnRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>

        <div class="line"></div>

        <div class="log" id="logBox"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // =========================
    // CONFIG
    // =========================
    const SUPABASE_URL = "https://vskoiojbedimfdatepqy.supabase.co";
    const SUPABASE_KEY = "sb_publishable_VcqtTyBpAwlpJuwh_Wc0tw_IPxVIsgP";
    const SITE_URL = "https://eduardzlobin.github.io/Apocalypse";

    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    // UI refs
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnFire = document.getElementById("btnFire");
    const btnCoal = document.getElementById("btnCoal");
    const btnFuel = document.getElementById("btnFuel");
    const btnRefresh = document.getElementById("btnRefresh");

    const remainText = document.getElementById("remainText");
    const burnText = document.getElementById("burnText");
    const untilText = document.getElementById("untilText");
    const statusText = document.getElementById("statusText");
    const whoText = document.getElementById("whoText");

    const coalCount = document.getElementById("coalCount");
    const fuelCount = document.getElementById("fuelCount");

    const chipUser = document.getElementById("chipUser");
    const chipCooldown = document.getElementById("chipCooldown");
    const chipStreak = document.getElementById("chipStreak");
    const logBox = document.getElementById("logBox");

    let state = {
      session: null,
      fire: null,
      profile: null,
      tickTimer: null
    };

    function fmtDT(x){
      if(!x) return "‚Äî";
      const d = new Date(x);
      return d.toLocaleString();
    }

    function fmtHours(h){
      if(h === null || h === undefined || isNaN(h)) return "‚Äî";
      const sign = h >= 0 ? "" : "-";
      h = Math.abs(h);
      const days = Math.floor(h / 24);
      const hours = Math.floor(h % 24);
      const mins = Math.floor((h*60) % 60);
      const parts = [];
      if(days) parts.push(`${days}–¥`);
      if(hours || days) parts.push(`${hours}—á`);
      parts.push(`${mins}–º`);
      return sign + parts.join(" ");
    }

    function setStatus(msg, kind="info"){
      statusText.textContent = msg;
      statusText.className = "";
      if(kind==="ok") statusText.classList.add("pillOk");
      if(kind==="bad") statusText.classList.add("pillBad");
    }

   function lockActions(locked){
  btnFire.disabled = locked; // üî• –º–æ–∂–Ω–æ –≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ –Ω–µ locked
  btnCoal.disabled = locked || !(state.profile && state.profile.coal > 0);
  btnFuel.disabled = locked || !(state.profile && state.profile.fuel > 0);
}

    function effectiveRemainingHours(){
      if(!state.fire) return null;
      const now = Date.now();
      const exp = new Date(state.fire.expires_at).getTime();
      let remH = (exp - now)/3600000;

      if(state.fire.multiplier_until && new Date(state.fire.multiplier_until).getTime() > now){
        const m = state.fire.burn_multiplier || 1.0;
        if(m > 0) remH = remH / m;
      }
      return remH;
    }

    function render(){
      const loggedIn = !!state.session;
      btnLogin.style.display = loggedIn ? "none" : "";
      btnLogout.style.display = loggedIn ? "" : "none";

      if(state.profile){
        coalCount.textContent = state.profile.coal ?? 0;
        fuelCount.textContent = state.profile.fuel ?? 0;

        const name =
          state.profile.username ||
          state.session?.user?.user_metadata?.full_name ||
          state.session?.user?.user_metadata?.name ||
          state.session?.user?.email ||
          "Discord User";

        chipUser.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${name}`;
        chipStreak.textContent = `–°—Ç—Ä–∏–∫: ${state.profile.streak ?? 0}`;

        const lf = state.profile.last_feed_at ? new Date(state.profile.last_feed_at).getTime() : 0;
        const next = lf ? lf + 20*3600*1000 : 0;
        chipCooldown.textContent = (next && next > Date.now())
          ? `–ö—É–ª–¥–∞—É–Ω: –¥–æ ${new Date(next).toLocaleString()}`
          : "–ö—É–ª–¥–∞—É–Ω: –≥–æ—Ç–æ–≤";
      } else {
        coalCount.textContent = "0";
        fuelCount.textContent = "0";
        chipUser.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ‚Äî";
        chipStreak.textContent = "–°—Ç—Ä–∏–∫: ‚Äî";
        chipCooldown.textContent = "–ö—É–ª–¥–∞—É–Ω: ‚Äî";
      }

      if(state.fire){
        const rem = effectiveRemainingHours();
        remainText.textContent = fmtHours(rem);

        const effectActive = state.fire.multiplier_until && new Date(state.fire.multiplier_until).getTime() > Date.now();
        burnText.textContent = effectActive ? `x${state.fire.burn_multiplier}` : "x1.0";
        untilText.textContent = effectActive ? fmtDT(state.fire.multiplier_until) : "‚Äî";

        if(rem !== null){
          if(rem <= 0) setStatus("–û–≥–æ–Ω—å –ø–æ—Ç—É—Ö. –ú–∏—Ä —É–∂–µ —Å—á–∏—Ç–∞–µ—Ç –∞–∫—Ç—ë—Ä–æ–≤ –∫–∞—Ç–∞–∫–ª–∏–∑–º–∞‚Ä¶", "bad");
          else if(rem < 6) setStatus("–ö–†–ò–¢–ò–ß–ù–û: –æ—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ. –ö—Ç–æ-—Ç–æ –¥–æ–ª–∂–µ–Ω –ø–æ–º–Ω–∏—Ç—å –∫–Ω–æ–ø–∫—É.", "bad");
          else setStatus("–û–≥–æ–Ω—å –∂–∏–≤. –ü–æ–∫–∞.", "ok");
        }
      } else {
        remainText.textContent = "‚Äî";
        burnText.textContent = "‚Äî";
        untilText.textContent = "‚Äî";
      }

      lockActions(!loggedIn);
      whoText.textContent = loggedIn ? "–í–∞—à–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: –≤–∫–ª—é—á–µ–Ω–∞" : "–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–¥–∫–∏–Ω—É—Ç—å –¥—Ä–æ–≤–∞";
    }

    async function loadFire(){
      const { data, error } = await sb
        .from("fire")
        .select("expires_at, burn_multiplier, multiplier_until")
        .eq("id", 1)
        .single();

      if(error){
        console.error(error);
        setStatus("–ù–µ –º–æ–≥—É –ø—Ä–æ—á–∏—Ç–∞—Ç—å fire (–ø—Ä–æ–≤–µ—Ä—å RLS/policies).", "bad");
        return;
      }
      state.fire = data;
    }

    async function loadProfile(){
  if(!state.session) { state.profile = null; return; }
  const uid = state.session.user.id;

  const { data, error } = await sb
    .from("profiles")
    .select("user_id, username, coal, fuel, streak, last_feed_at, last_streak_day")
    .eq("user_id", uid)
    .maybeSingle(); // ‚úÖ –≤–º–µ—Å—Ç–æ single()

  if(error){
    console.error(error);
    setStatus("–ù–µ –º–æ–≥—É –ø—Ä–æ—á–∏—Ç–∞—Ç—å profiles (–ø—Ä–æ–≤–µ—Ä—å RLS).", "bad");
    return;
  }

  state.profile = data; // –±—É–¥–µ—Ç null, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
}

    async function loadLogs(){
      const { data, error } = await sb
        .from("fire_log")
        .select("type, at, delta_hours, remaining_before, remaining_after, user_id")
        .order("at", { ascending: false })
        .limit(30);

      if(error){
        console.error(error);
        setStatus("–ù–µ –º–æ–≥—É –ø—Ä–æ—á–∏—Ç–∞—Ç—å fire_log (–ø—Ä–æ–≤–µ—Ä—å RLS).", "bad");
        return;
      }

      logBox.innerHTML = "";
      for(const row of data){
        const el = document.createElement("div");
        el.className = "logItem";

        const t = row.type || "‚Äî";
        const time = row.at ? new Date(row.at).toLocaleString() : "‚Äî";
        const dh = row.delta_hours ?? 0;

        let line = "";
        if(t === "FEED") line = dh > 0 ? `–ü–æ–¥–∫–∏–Ω—É–ª–∏: +${dh}—á` : "–ü–æ–¥–∫–∏–Ω—É–ª–∏";
        else if(t === "EVENT") line = dh !== 0 ? `–°–æ–±—ã—Ç–∏–µ: ${dh>0?"+":""}${dh}—á` : "–°–æ–±—ã—Ç–∏–µ (–º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä/—ç—Ñ—Ñ–µ–∫—Ç)";
        else if(t === "CATASTROPHE") line = "–ö–∞—Ç–∞–∫–ª–∏–∑–º: –æ–≥–æ–Ω—å –ø–æ—Ç—É—Ö";
        else line = "–ó–∞–ø–∏—Å—å";

        el.innerHTML = `
          <div class="logTop">
            <div class="logType">${t}</div>
            <div class="logTime">${time}</div>
          </div>
          <div class="logBody">
            ${line}<br/>
            –î–æ: <b>${fmtHours(row.remaining_before)}</b> ‚Üí –ü–æ—Å–ª–µ: <b>${fmtHours(row.remaining_after)}</b>
          </div>
        `;
        logBox.appendChild(el);
      }
    }

    function startTicker(){
      if(state.tickTimer) clearInterval(state.tickTimer);
      state.tickTimer = setInterval(()=>render(), 1000);
    }

    async function refreshAll(){
      await loadFire();
      await loadProfile();
      await loadLogs();
      render();
      startTicker();
    }

    // =========================
    // AUTH
    // =========================
    btnLogin.addEventListener("click", async () => {
      setStatus("–û—Ç–∫—Ä—ã–≤–∞—é Discord‚Ä¶", "info");
      const { error } = await sb.auth.signInWithOAuth({
        provider: "discord",
        options: { redirectTo: SITE_URL }
      });
      if(error){
        console.error(error);
        setStatus("–û—à–∏–±–∫–∞ –ª–æ–≥–∏–Ω–∞ Discord. –ü—Ä–æ–≤–µ—Ä—å Redirect URLs.", "bad");
      }
    });

    btnLogout.addEventListener("click", async () => {
      await sb.auth.signOut();
      state.session = null;
      state.profile = null;
      render();
    });

    // =========================
    // ACTIONS (RPC)
    // =========================
    async function callFeed(use_item){
      try{
        lockActions(true);
        setStatus("–ó–∞–ø—Ä–æ—Å –∫ —è–¥—Ä—É‚Ä¶", "info");

        const { data, error } = await sb.rpc("feed_fire", { use_item });

        if(error){
          console.error(error);
          const msg = (error.message || "").toString();

          if(msg.includes("COOLDOWN")){
            setStatus("–ö—É–ª–¥–∞—É–Ω: –µ—â—ë —Ä–∞–Ω–æ. (–°–º–æ—Ç—Ä–∏ —á–∏–ø '–ö—É–ª–¥–∞—É–Ω')", "bad");
          }else if(msg.includes("NO_COAL")){
            setStatus("–ù–µ—Ç —É–≥–ª—è –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ.", "bad");
          }else if(msg.includes("NO_FUEL")){
            setStatus("–ù–µ—Ç —Ç–æ–ø–ª–∏–≤–∞ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ.", "bad");
          }else if(msg.includes("NOT_AUTHENTICATED")){
            setStatus("–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏.", "bad");
          }else{
            setStatus("RPC –æ—à–∏–±–∫–∞: " + msg, "bad");
          }
          return;
        }

        if(data?.fire) state.fire = data.fire;
        if(data?.profile) state.profile = data.profile;

        setStatus("–ì–æ—Ç–æ–≤–æ. –ú–∏—Ä –æ—Ç–ª–æ–∂–µ–Ω –Ω–∞ –ø–æ—Ç–æ–º.", "ok");
        await loadLogs();
      } finally {
        lockActions(false);
        render();
      }
    }

    btnFire.addEventListener("click", ()=> callFeed("wood"));
    btnCoal.addEventListener("click", ()=> callFeed("coal"));
    btnFuel.addEventListener("click", ()=> callFeed("fuel"));
    btnRefresh.addEventListener("click", refreshAll);

    // init
    async function ensureProfile(){
  if(!state.session) return;
  const { error } = await sb.rpc("ensure_profile");
  if(error) console.error("ensure_profile error:", error);
}

(async function init(){
  const { data } = await sb.auth.getSession();
  state.session = data.session || null;

  if(state.session) await ensureProfile();  // ‚úÖ –¥–æ–±–∞–≤–∏–ª–∏

  sb.auth.onAuthStateChange(async (_event, session) => {
    state.session = session;
    if(state.session) await ensureProfile(); // ‚úÖ –¥–æ–±–∞–≤–∏–ª–∏
    await refreshAll();
  });

  await refreshAll();
  setStatus("–ì–æ—Ç–æ–≤. –≠—Ç–æ –Ω–µ —Å–∞–π—Ç ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∂–∏–∑–Ω–µ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è.", "ok");
})();
  </script>
</body>
</html>
