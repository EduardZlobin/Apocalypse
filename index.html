<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Apocalypse ‚Äî Daily Flame</title>

  <!-- Chart.js + Luxon time adapter (—á—Ç–æ–±—ã time scale –Ω–µ –ø–∞–¥–∞–ª) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

  <style>
    :root{
      --bg0:#070812;
      --bg1:#0b0f1f;
      --card:rgba(255,255,255,.06);
      --txt:rgba(255,255,255,.92);
      --mut:rgba(255,255,255,.62);
      --bad:#ff5a6b;
      --ok:#6dffb3;
      --ring:rgba(255,255,255,.12);
      --ring2:rgba(255,255,255,.20);
      --shadow: 0 20px 80px rgba(0,0,0,.55);
      --glass: blur(14px) saturate(120%);
      --radius: 18px;
      --btn: rgba(255,255,255,.08);
      --btnh: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(120,80,255,.25), transparent 55%),
        radial-gradient(700px 600px at 80% 20%, rgba(50,180,255,.18), transparent 55%),
        radial-gradient(800px 700px at 50% 80%, rgba(255,120,80,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
      overflow-x:hidden;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:18px 18px 64px;}
    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 12px;
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:var(--radius);
      backdrop-filter: var(--glass);
      box-shadow: var(--shadow);
      position:sticky;
      top:12px;
      z-index:10;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .dot{
      width:12px; height:12px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.2));
      box-shadow: 0 0 24px rgba(160,120,255,.45);
    }
    .title{font-weight:800; letter-spacing:.4px}
    .subtitle{color:var(--mut); font-size:12px; margin-top:2px}
    .btn{
      border:1px solid var(--ring);
      background:var(--btn);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.15s;
      backdrop-filter: var(--glass);
    }
    .btn:hover{background:var(--btnh); transform: translateY(-1px)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:18px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .panel{
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:var(--radius);
      padding:16px;
      backdrop-filter: var(--glass);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .sectionTitle{font-weight:900; font-size:16px;}
    .small{font-size:12px; color:var(--mut)}
    .line{height:1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,.14), transparent); margin:12px 0;}

    /* Core */
    .coreWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      min-height: 460px;
      gap:14px;
      position:relative;
    }
    .ring{
      position:absolute;
      width:520px; height:520px;
      border-radius:50%;
      border:1px solid var(--ring);
      opacity:.55;
      animation: spin 18s linear infinite;
    }
    .ring2{
      position:absolute;
      width:420px; height:420px;
      border-radius:50%;
      border:1px dashed var(--ring2);
      opacity:.35;
      animation: spin 28s linear reverse infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .fireBtn{
      width:240px; height:240px;
      border-radius:50%;
      border:1px solid var(--ring2);
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.22), rgba(255,255,255,.06) 55%, rgba(0,0,0,.25));
      box-shadow: 0 10px 70px rgba(0,0,0,.55), 0 0 120px rgba(255,120,80,.22);
      cursor:pointer;
      display:grid;
      place-items:center;
      position:relative;
      user-select:none;
      transition:.16s;
      backdrop-filter: var(--glass);
    }
    .fireBtn:hover{transform: translateY(-2px) scale(1.01)}
    .fireBtn:active{transform: translateY(0px) scale(.99)}
    .fireBtn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    .inv{display:flex; gap:12px; align-items:center; justify-content:center; margin-top:4px;}
    .invBtn{
      width:74px; height:74px;
      border-radius:50%;
      border:1px solid var(--ring);
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.18), rgba(255,255,255,.06) 60%);
      display:grid;
      place-items:center;
      cursor:pointer;
      position:relative;
      transition:.16s;
      backdrop-filter: var(--glass);
    }
    .invBtn:hover{transform: translateY(-2px)}
    .invBtn:active{transform: translateY(0px)}
    .invBtn:disabled{opacity:.45; cursor:not-allowed; transform:none}
    .badge{
      position:absolute;
      bottom:-6px; right:-6px;
      min-width:26px; height:26px;
      border-radius:999px;
      padding:0 8px;
      display:flex; align-items:center; justify-content:center;
      font-size:12px;
      background:rgba(0,0,0,.35);
      border:1px solid var(--ring);
      color:var(--txt);
      backdrop-filter: var(--glass);
    }
    .meta{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; color:var(--mut); font-size:13px; margin-top:8px; text-align:center;}
    .kpi{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .chip{padding:8px 10px; border-radius:999px; border:1px solid var(--ring); background: rgba(255,255,255,.05); font-size:12px; color:var(--mut);}

    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--ring);
      background:rgba(255,255,255,.04);
      color:var(--mut);
      min-height:42px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      width:min(720px, 100%);
    }
    .status b{color:var(--txt)}
    .pillOk{color:var(--ok)}
    .pillBad{color:var(--bad)}

    /* Logs */
    .log{display:flex; flex-direction:column; gap:10px; max-height:520px; overflow:auto; padding-right:6px;}
    .logItem{border:1px solid var(--ring); background:rgba(255,255,255,.04); border-radius:14px; padding:10px 12px;}
    .logTop{display:flex; justify-content:space-between; gap:10px; align-items:center}
    .logType{font-weight:800}
    .logTime{font-size:12px; color:var(--mut)}
    .logBody{margin-top:6px; color:var(--mut); font-size:13px; line-height:1.35}

    /* Lore */
    .lore{
      max-width: 860px;
      margin: 10px auto 0;
      border:1px solid var(--ring);
      border-radius: 16px;
      padding: 12px 14px;
      background: rgba(255,255,255,.03);
      color: var(--mut);
      line-height: 1.5;
    }
    .lore b{color:var(--txt)}

    /* Catastrophe overlay */
    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(8px);
      z-index:999;
    }
    .overlay.show{display:flex;}
    .overlayCard{
      max-width: 980px;
      width: 100%;
      background: rgba(20,10,14,.72);
      border: 1px solid rgba(255,90,107,.35);
      border-radius: 22px;
      padding: 18px 18px 14px;
      box-shadow: 0 30px 120px rgba(0,0,0,.7);
      position:relative;
      overflow:hidden;
    }
    .overlayTitle{
      font-weight: 950;
      font-size: 18px;
      color: var(--bad);
      letter-spacing: .2px;
      margin-bottom: 10px;
    }
    .overlayText{color: rgba(255,255,255,.88); line-height:1.55}
    .overlayHint{color: rgba(255,255,255,.65); font-size:12px; margin-top: 10px}
    .closeX{
      position:absolute; top:12px; right:12px;
      width:40px; height:40px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
      cursor:pointer;
    }
    footer{margin-top:18px; text-align:center; color:var(--mut); font-size:12px}
    canvas{max-width:100%; background: rgba(255,255,255,.02); border:1px solid var(--ring); border-radius: 14px;}

    .eventGlow{
      box-shadow:
        0 0 18px rgba(255,255,255,.55),
        0 0 60px rgba(255,255,255,.35),
        0 0 120px rgba(255,255,255,.18),
        0 10px 70px rgba(0,0,0,.55);
      border-color: rgba(255,255,255,.55) !important;
    }

    /* Fire icon */
    .fireIcon{
      width: 140px;
      height: 140px;
      object-fit: contain;
      transform: translateY(-6px);
      filter: drop-shadow(0 10px 24px rgba(0,0,0,.55));
      transition: transform .18s ease, filter .18s ease, opacity .18s ease;
      animation: iconFlicker 2.8s ease-in-out infinite;
      user-select:none;
      pointer-events:none;
    }
    @keyframes iconFlicker{
      0%,100%{transform: translateY(-6px) scale(1)}
      50%{transform: translateY(-10px) scale(1.02)}
    }

    /* Admin modal (glass) */
    .adminModal{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px) saturate(120%);
      z-index:9999;
    }
    .adminCard{
      width:min(720px, 100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      box-shadow: 0 20px 90px rgba(0,0,0,.6);
      backdrop-filter: blur(14px) saturate(120%);
      overflow:hidden;
    }
    .adminTitle{ margin:0; padding:16px 18px 10px; font-size:18px; font-weight:900; }
    .adminBody{ padding:0 18px 18px; }
    .adminLabel{ display:block; margin:10px 0 6px; font-size:12px; color: rgba(255,255,255,.68); }
    .adminInput,.adminTextarea,.adminSelect{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.92);
      outline:none;
      padding:10px 12px;
      transition: .15s;
    }
    .adminTextarea{ min-height:84px; resize: vertical; }
    .adminGrid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:6px; }
    @media (max-width: 640px){ .adminGrid2{ grid-template-columns: 1fr; } }
    .adminActions{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
    .adminHint{ margin-top:10px; font-size:12px; color: rgba(255,255,255,.62); line-height:1.35; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">ZLOBAK / Daily Flame</div>
          <div class="subtitle">–û–≥–æ–Ω—å –æ–±—â–∏–π. –ú–∏—Ä –¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ –≤–æ–ª–æ—Å–∫–µ –æ—Ç –≥–æ—Ä–æ—Ö–∞.</div>
        </div>
      </div>

      <div class="btnRow">
        <button class="btn" id="btnLogin">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord</button>
        <button class="btn" id="btnLogout" style="display:none;">–í—ã–π—Ç–∏</button>
        <button class="btn" id="btnAdmin" style="display:none;">–ê–¥–º–∏–Ω</button>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="coreWrap">
          <div class="ring"></div>
          <div class="ring2"></div>

          <div class="small" id="epochAgeText" style="text-align:center; width:100%;"></div>

          <button class="fireBtn" id="btnFire" disabled title="–ü–æ–¥–∫–∏–Ω—É—Ç—å –¥—Ä–æ–≤–∞ (+24—á, –∫—É–ª–¥–∞—É–Ω 20—á)">
            <img id="fireIcon" class="fireIcon" src="./assets/fire2.png" alt="fire">
          </button>

          <!-- Event bar -->
          <div id="eventBar" style="display:none; width:min(720px,100%); margin-top:8px;">
            <div id="eventTitle" style="text-align:center; font-weight:900; margin-bottom:6px;"></div>
            <div style="height:10px; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.12); border-radius:999px; overflow:hidden;">
              <div id="eventProgress" style="height:10px; width:0%; background:rgba(255,255,255,.92); border-radius:999px;"></div>
            </div>
          </div>

          <!-- Rapid click button -->
          <button class="fireBtn" id="btnRapid" style="display:none;" title="–ò–≤–µ–Ω—Ç: +10 —Å–µ–∫—É–Ω–¥ –∑–∞ –∫–ª–∏–∫ (–∫–¥ 0.15—Å)">
            <div style="font-size:78px; filter: drop-shadow(0 10px 24px rgba(0,0,0,.55)); transform: translateY(-6px);">‚ö°</div>
          </button>

          <div class="inv">
            <button class="invBtn" id="btnCoal" disabled title="–£–≥–æ–ª—å: +30—á (–±–µ–∑ –∫—É–ª–¥–∞—É–Ω–∞)">
              <div style="font-size:28px; filter: drop-shadow(0 8px 16px rgba(0,0,0,.55));">ü™®</div>
              <div class="badge" id="coalCount">0</div>
            </button>

            <button class="invBtn" id="btnFuel" disabled title="–¢–æ–ø–ª–∏–≤–æ: –∑–∞–º–µ–¥–ª—è–µ—Ç –≥–æ—Ä–µ–Ω–∏–µ x0.5 –Ω–∞ 24—á">
              <div style="font-size:28px; filter: drop-shadow(0 8px 16px rgba(0,0,0,.55));">üß™</div>
              <div class="badge" id="fuelCount">0</div>
            </button>
          </div>

          <div class="meta">
            <span>–û—Å—Ç–∞–ª–æ—Å—å: <b id="remainText">‚Äî</b></span>
            <span>‚Ä¢</span>
            <span>–°–∫–æ—Ä–æ—Å—Ç—å: <b id="burnText">‚Äî</b></span>
            <span>‚Ä¢</span>
            <span>–≠—Ñ—Ñ–µ–∫—Ç –¥–æ: <b id="untilText">‚Äî</b></span>
          </div>

          <div class="status">
            <div>–°—Ç–∞—Ç—É—Å: <b id="statusText">–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</b></div>
            <div class="small" id="whoText">‚Äî</div>
          </div>

          <div class="line"></div>

          <div class="kpi">
            <div class="chip" id="chipUser">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ‚Äî</div>
            <div class="chip" id="chipCooldown">–ö—É–ª–¥–∞—É–Ω: ‚Äî</div>
            <div class="chip" id="chipStreak">–°—Ç—Ä–∏–∫: ‚Äî</div>
            <div class="chip" id="chipEpoch">–≠–ø–æ—Ö–∞: ‚Äî</div>
            <div class="chip" id="chipNextEvent">–°–æ–±—ã—Ç–∏–µ: ‚Äî</div>
          </div>

          <div class="lore" id="loreBlock">
            <b>–ó–ª–æ–±–∏–Ω –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç:</b> —ç—Ç–æ—Ç –æ–≥–æ–Ω—å ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ, —á—Ç–æ –µ–≥–æ —Å–¥–µ—Ä–∂–∏–≤–∞–µ—Ç. –û–Ω –º–æ–∂–µ—Ç –∑–∞–π—Ç–∏ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç,
            —á—Ç–æ–±—ã —Ä–∞–∑–æ–≥—Ä–µ—Ç—å —Å–≤–æ–π –∫–æ—Ç–µ–ª–æ–∫ –≥–æ—Ä–æ—Ö–æ–≤–æ–≥–æ —Å—É–ø–∞. –ï—Å–ª–∏ –æ–≥–æ–Ω—å –ø–æ–≥–∞—Å–Ω–µ—Ç, –ó–ª–æ–±–∏–Ω —Å–∏–ª—å–Ω–æ —Ä–∞–∑–æ–∑–ª–∏—Ç—Å—è –∏ –ø—É—Å—Ç–∏—Ç –≤—Å—é —ç–Ω–µ—Ä–≥–∏—é
            —Å—É–ø–∞ –Ω–∞ —è–¥–µ—Ä–Ω—ã–π —Å–∏–Ω—Ç–µ–∑. –ê —ç—Ç–æ —É–∂–µ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –Ω–∞—Å—Ç–æ—è—â–µ–π –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–µ. –¢–∞–∫ —á—Ç–æ –ª—É—á—à–µ –Ω–µ –¥–∞–≤–∞–π –ø–ª–∞–º–µ–Ω–∏ –ø–æ–≥–∞—Å–Ω—É—Ç—å,
            –µ—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—à—å –ø—Ä–æ–±–ª–µ–º.
          </div>

          <div class="line"></div>

          <div style="width:100%">
            <div class="sectionTitle">–ì—Ä–∞—Ñ–∏–∫ —É–≥—Ä–æ–∑—ã</div>
            <div class="small">–ß–µ–º –Ω–∏–∂–µ –ª–∏–Ω–∏—è ‚Äî —Ç–µ–º –±–ª–∏–∂–µ –º–∏—Ä –±—ã–ª –∫ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–µ.</div>
            <div class="line"></div>
            <canvas id="chart" height="160"></canvas>
          </div>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px;">
          <div>
            <div class="sectionTitle">–ò—Å—Ç–æ—Ä–∏—è / –õ–æ–≥–∏</div>
            <div class="small">–ü–∏–∫–∏ –∏ —è–º—ã ‚Äî —Ç–µ–ø–µ—Ä—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ.</div>
          </div>
          <button class="btn" id="btnRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>

        <div class="line"></div>
        <div class="log" id="logBox"></div>
      </div>
    </div>

    <footer>
      –ï—Å–ª–∏ –≤—ã —á–∏—Ç–∞–µ—Ç–µ —ç—Ç–æ ‚Äî –∑–Ω–∞—á–∏—Ç —Å–∏—Ä–µ–Ω–∞ –ø–æ–∫–∞ –º–æ–ª—á–∏—Ç. –ü–æ–ª—å–∑—É–π—Ç–µ—Å—å.
    </footer>
  </div>

  <!-- Catastrophe overlay -->
  <div class="overlay" id="overlay">
    <div class="overlayCard">
      <button class="closeX" id="btnCloseOverlay">‚úï</button>
      <div class="overlayTitle">CATASTROPHE</div>
      <div class="overlayText" id="catText">
        –ó–ª–æ–±–∏–Ω –ø—Ä–∏—à–µ–ª, –∞ –æ–≥–æ–Ω—å –ø–æ–≥–∞—Å. –¢–µ–ø–µ—Ä—å –æ–Ω –≤ —è—Ä–æ—Å—Ç–∏ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏–ª –≤—Å—é —ç–Ω–µ—Ä–≥–∏—é –∏–∑ –≥–æ—Ä–æ—Ö–æ–≤–æ–≥–æ —Å—É–ø–∞ –≤ —è–¥–µ—Ä–Ω—ã–π —Å–∏–Ω—Ç–µ–∑.
        –¢—ã –¥–æ–ø—É—Å—Ç–∏–ª –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—É, –∏ —Ç–µ–ø–µ—Ä—å –ø—É—Ç–∏ –Ω–∞–∑–∞–¥ –Ω–µ—Ç ‚Äî —Å—É–ø —Ö–æ–ª–æ–¥–Ω—ã–π, –∞ –º–∏—Ä –Ω–∞ –≥—Ä–∞–Ω–∏ –≤–∑—Ä—ã–≤–∞.
        –ü–æ–∫–∞ —Ç—ã —ç—Ç–æ —á–∏—Ç–∞–µ—à—å, –æ—Å—Ç–∞—Ç–∫–∏ —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞ –≤ —Å–ø–µ—à–∫–µ —Å–ø—É—Å–∫–∞—é—Ç—Å—è –≤ –±—É–Ω–∫–µ—Ä—ã.
        –ù–∞–¥–µ—é—Å—å, —Ç—ã –¥–æ–≤–æ–ª–µ–Ω —Å–æ–±–æ–π, –≤–µ–¥—å —Ç–µ–ø–µ—Ä—å –Ω–∞–º –≤—Å–µ–º –ø—Ä–∏–¥–µ—Ç—Å—è –∂–∏—Ç—å –ø–æ–¥ –∑–µ–º–ª–µ–π –∏–∑-–∑–∞ –æ–¥–Ω–æ–≥–æ –æ—Å—Ç—ã–≤—à–µ–≥–æ –∫–æ—Ç–µ–ª–∫–∞.
      </div>
      <div class="overlayHint">–°–∏—Ä–µ–Ω–∞ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –æ–≥–æ–Ω—å —Å–Ω–æ–≤–∞ –∂–∏–≤ (–∏–ª–∏ –µ—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ ‚Äî –Ω–æ —Å–æ–≤–µ—Å—Ç—å –Ω–µ –∑–∞–∫—Ä–æ–µ—à—å).</div>
    </div>
  </div>

  <!-- Admin modal -->
  <div id="adminModal" class="adminModal">
    <div class="adminCard">
      <h2 class="adminTitle">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>
      <div class="adminBody">
        <label class="adminLabel">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input id="evTitle" class="adminInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">

        <label class="adminLabel">–û–ø–∏—Å–∞–Ω–∏–µ (–ª–æ—Ä)</label>
        <textarea id="evDesc" class="adminTextarea" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>

        <label class="adminLabel">–¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è (–≤–∏—Å–∏—Ç 12 —á–∞—Å–æ–≤)</label>
        <textarea id="evEndText" class="adminTextarea" placeholder="–¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è"></textarea>

        <label class="adminLabel">–¢–∏–ø –∏–≤–µ–Ω—Ç–∞</label>
        <select id="evType" class="adminSelect">
          <option value="rapid_click">rapid_click (–∫–∞–∂–¥—ã–π –∫–ª–∏–∫ +10 —Å–µ–∫)</option>
        </select>

        <div class="adminGrid2">
          <div>
            <label class="adminLabel">–ù–∞—á–∞–ª–æ</label>
            <input id="evStart" type="datetime-local" class="adminInput">
          </div>
          <div>
            <label class="adminLabel">–ö–æ–Ω–µ—Ü</label>
            <input id="evEnd" type="datetime-local" class="adminInput">
          </div>
        </div>

        <div class="adminActions">
          <button id="btnCreateEvent" class="btn">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
          <button id="btnCloseAdmin" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <div class="adminHint" id="adminHint">–ù–∞—á–∞–ª–æ/–ö–æ–Ω–µ—Ü ‚Äî —ç—Ç–æ —Å—Ç–∞—Ä—Ç –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≤–µ–Ω—Ç–∞.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // === CONFIG
    const SUPABASE_URL = "https://vskoiojbedimfdatepqy.supabase.co";
    const SUPABASE_KEY = "sb_publishable_VcqtTyBpAwlpJuwh_Wc0tw_IPxVIsgP";
    const SITE_URL = "https://eduardzlobin.github.io/Apocalypse";

    // –í–ê–ñ–ù–û: —ç—Ç–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å user_id (uuid) –∞–¥–º–∏–Ω–∞ –≤ Supabase auth.users
    const ADMIN_ID = "310f1196-021e-4251-b0e5-33d4d895dcc8";

    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    // === UI refs
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnAdmin = document.getElementById("btnAdmin");
    const btnRefresh = document.getElementById("btnRefresh");

    const btnFire = document.getElementById("btnFire");
    const btnCoal = document.getElementById("btnCoal");
    const btnFuel = document.getElementById("btnFuel");
    const btnRapid = document.getElementById("btnRapid");

    const remainText = document.getElementById("remainText");
    const burnText = document.getElementById("burnText");
    const untilText = document.getElementById("untilText");
    const statusText = document.getElementById("statusText");
    const whoText = document.getElementById("whoText");

    const coalCount = document.getElementById("coalCount");
    const fuelCount = document.getElementById("fuelCount");

    const chipUser = document.getElementById("chipUser");
    const chipCooldown = document.getElementById("chipCooldown");
    const chipStreak = document.getElementById("chipStreak");
    const chipEpoch = document.getElementById("chipEpoch");
    const chipNextEvent = document.getElementById("chipNextEvent");
    const epochAgeText = document.getElementById("epochAgeText");

    const logBox = document.getElementById("logBox");
    const loreBlock = document.getElementById("loreBlock");

    const eventBar = document.getElementById("eventBar");
    const eventTitle = document.getElementById("eventTitle");
    const eventProgress = document.getElementById("eventProgress");

    const fireIcon = document.getElementById("fireIcon");

    const overlay = document.getElementById("overlay");
    const btnCloseOverlay = document.getElementById("btnCloseOverlay");

    // Admin modal
    const adminModal = document.getElementById("adminModal");
    const btnCloseAdmin = document.getElementById("btnCloseAdmin");
    const btnCreateEvent = document.getElementById("btnCreateEvent");
    const adminHint = document.getElementById("adminHint");
    const evTitle = document.getElementById("evTitle");
    const evDesc = document.getElementById("evDesc");
    const evEndText = document.getElementById("evEndText");
    const evType = document.getElementById("evType");
    const evStart = document.getElementById("evStart");
    const evEnd = document.getElementById("evEnd");

    // === STATE
    let state = { session:null, fire:null, profile:null, logs:[], tickTimer:null };
    let chart = null;

    // event display
    let activeEvent = null;     // —Å–µ–π—á–∞—Å –∏–¥—ë—Ç
    let postEvent = null;       // –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å <=12—á –Ω–∞–∑–∞–¥

    let rapidLock = false;

    // === Utils
    const fmtDT = (x)=> x ? new Date(x).toLocaleString() : "‚Äî";

    function fmtHours(h){
      if(h === null || h === undefined || isNaN(h)) return "‚Äî";
      const sign = h >= 0 ? "" : "-";
      h = Math.abs(h);
      const days = Math.floor(h / 24);
      const hours = Math.floor(h % 24);
      const mins = Math.floor((h*60) % 60);
      const parts = [];
      if(days) parts.push(`${days}–¥`);
      if(hours || days) parts.push(`${hours}—á`);
      parts.push(`${mins}–º`);
      return sign + parts.join(" ");
    }

    function setStatus(msg, kind="info"){
      statusText.textContent = msg;
      statusText.className = "";
      if(kind==="ok") statusText.classList.add("pillOk");
      if(kind==="bad") statusText.classList.add("pillBad");
    }

    function checkAdmin(){
      return state.session?.user?.id === ADMIN_ID;
    }

    function lockActions(locked){
      btnFire.disabled = locked || !state.session;
      btnCoal.disabled = locked || !state.session || !(state.profile && (state.profile.coal ?? 0) > 0);
      btnFuel.disabled = locked || !state.session || !(state.profile && (state.profile.fuel ?? 0) > 0);
    }

    function pickFireIcon(remH){
      if(remH === null || remH === undefined || isNaN(remH)) return "./assets/fire2.png";
      if(remH <= 0) return "./assets/fire0.png";
      if(remH < 24) return "./assets/fire1.png";
      if(remH >= 24*25) return "./assets/fire5.png";
      if(remH >= 24*10) return "./assets/fire4.png";
      if(remH >= 24*5) return "./assets/fire3.png";
      return "./assets/fire2.png";
    }

    function remainingHoursBase(fire){
      if(!fire?.expires_at) return null;
      const now = Date.now();
      const exp = new Date(fire.expires_at).getTime();
      return (exp - now) / 3600000;
    }

    function effectiveRemainingHours(fire){
      const base = remainingHoursBase(fire);
      if(base === null) return null;

      const now = Date.now();
      const active = !!(fire.multiplier_until && new Date(fire.multiplier_until).getTime() > now);
      const m = active ? (fire.burn_multiplier || 1.0) : 1.0;
      return m > 0 ? (base / m) : base;
    }

    // === Siren (WebAudio, –±–µ–∑ —Ñ–∞–π–ª–æ–≤)
    let audioCtx = null, sirenOsc = null, sirenGain = null, sirenTimer = null;
    function sirenStart(){
      if(sirenOsc) return;
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      sirenOsc = audioCtx.createOscillator();
      sirenGain = audioCtx.createGain();
      sirenOsc.type = "sawtooth";
      sirenGain.gain.value = 0.0001;
      sirenOsc.connect(sirenGain);
      sirenGain.connect(audioCtx.destination);
      sirenOsc.start();

      let up = true;
      sirenTimer = setInterval(()=>{
        if(!sirenOsc) return;
        const t = audioCtx.currentTime;
        const f = up ? 880 : 520;
        up = !up;
        sirenOsc.frequency.setTargetAtTime(f, t, 0.05);
        sirenGain.gain.setTargetAtTime(0.12, t, 0.02);
      }, 380);
    }
    function sirenStop(){
      if(sirenTimer){ clearInterval(sirenTimer); sirenTimer=null; }
      if(sirenOsc){
        try{
          const t = audioCtx.currentTime;
          sirenGain.gain.setTargetAtTime(0.0001, t, 0.03);
          setTimeout(()=>{ try{ sirenOsc.stop(); }catch{} sirenOsc=null; sirenGain=null; }, 140);
        } catch {
          sirenOsc=null; sirenGain=null;
        }
      }
    }
    function overlayShow(){ overlay.classList.add("show"); sirenStart(); }
    function overlayHide(){ overlay.classList.remove("show"); }

    btnCloseOverlay.addEventListener("click", overlayHide);
    overlay.addEventListener("click", (e)=>{ if(e.target === overlay) overlayHide(); });

    // === Render
    function render(){
      const loggedIn = !!state.session;

      btnLogin.style.display = loggedIn ? "none" : "";
      btnLogout.style.display = loggedIn ? "" : "none";
      btnAdmin.style.display = checkAdmin() ? "" : "none";

      // profile
      if(state.profile){
        coalCount.textContent = state.profile.coal ?? 0;
        fuelCount.textContent = state.profile.fuel ?? 0;

        const name =
          state.profile.username ||
          state.session?.user?.user_metadata?.full_name ||
          state.session?.user?.user_metadata?.name ||
          "Discord User";

        chipUser.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${name}`;
        chipStreak.textContent = `–°—Ç—Ä–∏–∫: ${state.profile.streak ?? 0}`;

        const lf = state.profile.last_feed_at ? new Date(state.profile.last_feed_at).getTime() : 0;
        const next = lf ? lf + 20*3600*1000 : 0;
        chipCooldown.textContent = (next && next > Date.now())
          ? `–ö—É–ª–¥–∞—É–Ω: –¥–æ ${new Date(next).toLocaleString()}`
          : "–ö—É–ª–¥–∞—É–Ω: –≥–æ—Ç–æ–≤";
      } else {
        coalCount.textContent = "0";
        fuelCount.textContent = "0";
        chipUser.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ‚Äî";
        chipStreak.textContent = "–°—Ç—Ä–∏–∫: ‚Äî";
        chipCooldown.textContent = "–ö—É–ª–¥–∞—É–Ω: ‚Äî";
      }

      // fire
      if(state.fire){
        const rem = effectiveRemainingHours(state.fire);
        remainText.textContent = fmtHours(rem);

        // effect label
        const now = Date.now();
        const effectActive = !!(state.fire.multiplier_until && new Date(state.fire.multiplier_until).getTime() > now);
        burnText.textContent = effectActive ? `x${state.fire.burn_multiplier}` : "x1.0";
        untilText.textContent = effectActive ? fmtDT(state.fire.multiplier_until) : "‚Äî";

        // epoch
        chipEpoch.textContent = `–≠–ø–æ—Ö–∞: ${state.fire.epoch ?? "‚Äî"}`;

        if(state.fire.epoch_started_at){
          const start = new Date(state.fire.epoch_started_at).getTime();
          const diff = Math.max(0, Date.now() - start);
          const days = Math.floor(diff / (24*3600*1000));
          const hours = Math.floor((diff % (24*3600*1000)) / (3600*1000));
          epochAgeText.textContent = `–≠–ø–æ—Ö–∞ –≥–æ—Ä–∏—Ç —É–∂–µ: ${days}–¥ ${hours}—á`;
        }else{
          epochAgeText.textContent = "";
        }

        // icon
        const nextSrc = pickFireIcon(rem);
        if(fireIcon && fireIcon.getAttribute("src") !== nextSrc){
          fireIcon.style.opacity = "0.35";
          setTimeout(()=>{
            fireIcon.src = nextSrc;
            fireIcon.style.opacity = "1";
          }, 80);
        }

        // glow if < 6 hours
        if(fireIcon){
          if(rem !== null && rem < 6 && rem > 0){
            fireIcon.style.filter =
              "drop-shadow(0 0 18px rgba(255,90,107,.35)) drop-shadow(0 10px 24px rgba(0,0,0,.55))";
          }else{
            fireIcon.style.filter = "drop-shadow(0 10px 24px rgba(0,0,0,.55))";
          }
        }

        if(rem !== null){
          if(rem <= 0){
            setStatus("–û–≥–æ–Ω—å –ø–æ—Ç—É—Ö. –≠—Ç–æ –Ω–µ –±–∞–≥ ‚Äî —ç—Ç–æ —Å—é–∂–µ—Ç.", "bad");
            overlayShow();
          }else if(rem < 6){
            setStatus("–ö–†–ò–¢–ò–ß–ù–û: –æ—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ. –ö—Ç–æ-—Ç–æ –¥–æ–ª–∂–µ–Ω –ø–æ–º–Ω–∏—Ç—å –∫–Ω–æ–ø–∫—É.", "bad");
            if(overlay.classList.contains("show")) overlayHide();
            sirenStop();
          }else{
            setStatus("–û–≥–æ–Ω—å –∂–∏–≤. –ü–æ–∫–∞.", "ok");
            if(overlay.classList.contains("show")) overlayHide();
            sirenStop();
          }
        }
      }else{
        remainText.textContent = "‚Äî";
        burnText.textContent = "‚Äî";
        untilText.textContent = "‚Äî";
        chipEpoch.textContent = "–≠–ø–æ—Ö–∞: ‚Äî";
        epochAgeText.textContent = "";
      }

      // event chip + lore (–∞–∫—Ç–∏–≤–Ω—ã–π / –ø–æ—Å—Ç-—Ç–µ–∫—Å—Ç)
      if(activeEvent){
        chipNextEvent.textContent = `–°–æ–±—ã—Ç–∏–µ: ${activeEvent.title || "–ò–≤–µ–Ω—Ç"}`;
        loreBlock.innerHTML = `<b>${activeEvent.title || "–ò–≤–µ–Ω—Ç"}:</b> ${activeEvent.description || ""}`;
      }else if(postEvent){
        chipNextEvent.textContent = `–°–æ–±—ã—Ç–∏–µ: –∑–∞–≤–µ—Ä—à–µ–Ω–æ`;
        loreBlock.innerHTML = `<b>–ü–æ—Å–ª–µ –∏–≤–µ–Ω—Ç–∞:</b> ${postEvent.end_text || ""}`;
      }else{
        chipNextEvent.textContent = "–°–æ–±—ã—Ç–∏–µ: ‚Äî";
        // loreBlock –æ—Å—Ç–∞–≤–ª—è–µ–º ‚Äú–ó–ª–æ–±–∏–Ω –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç‚Äù –∫–∞–∫ –≤ HTML (–Ω–µ –ø–µ—Ä–µ—Ç–∏—Ä–∞–µ–º)
      }

      lockActions(false);
      whoText.textContent = loggedIn ? "–í–∞—à–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: –≤–∫–ª—é—á–µ–Ω–∞" : "–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–¥–∫–∏–Ω—É—Ç—å –¥—Ä–æ–≤–∞";
    }

    function renderEventUI(){
      // –±–∞–∑–æ–≤–æ: –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º
      btnRapid.style.display = "none";
      eventBar.style.display = "none";
      btnFire.style.display = "";

      btnRapid.classList.remove("eventGlow");
      btnFire.classList.remove("eventGlow");

      if(!activeEvent) return;

      // bar
      eventBar.style.display = "";
      eventTitle.textContent = activeEvent.title || "–ò–≤–µ–Ω—Ç";

      const now = Date.now();
      const start = new Date(activeEvent.starts_at).getTime();
      const end = new Date(activeEvent.ends_at).getTime();
      const pct = Math.max(0, Math.min(1, (now - start) / (end - start)));
      eventProgress.style.width = (pct * 100).toFixed(2) + "%";

      if(activeEvent.event_type === "rapid_click"){
        btnFire.style.display = "none";
        btnRapid.style.display = "";
        btnRapid.classList.add("eventGlow");
      }
    }

    // === Data
    async function ensureProfile(){
      if(!state.session) return;
      const { error } = await sb.rpc("ensure_profile");
      if(error) console.warn("ensure_profile:", error);
    }

    async function loadFire(){
      const { data, error } = await sb
        .from("fire")
        .select("expires_at, burn_multiplier, multiplier_until, epoch, next_event_at, epoch_started_at")
        .eq("id", 1)
        .single();
      if(error){ console.error(error); setStatus("–ù–µ –º–æ–≥—É –ø—Ä–æ—á–∏—Ç–∞—Ç—å fire (RLS?).", "bad"); return; }
      state.fire = data;
    }

    async function loadProfile(){
      if(!state.session){ state.profile=null; return; }
      const uid = state.session.user.id;
      const { data, error } = await sb
        .from("profiles")
        .select("user_id, username, coal, fuel, streak, last_feed_at, last_streak_day, last_reward_day")
        .eq("user_id", uid)
        .maybeSingle();
      if(error){ console.error(error); setStatus("–ù–µ –º–æ–≥—É –ø—Ä–æ—á–∏—Ç–∞—Ç—å profiles (RLS?).", "bad"); return; }
      state.profile = data;
    }

    async function loadLogs(){
      const { data, error } = await sb
        .from("fire_log")
        .select("type, at, delta_hours, remaining_before, remaining_after, user_id, details")
        .order("at", { ascending: false })
        .limit(60);

      if(error){ console.error("fire_log error:", error); return; }

      state.logs = data || [];
      logBox.innerHTML = "";
      for(const row of state.logs){
        const el = document.createElement("div");
        el.className = "logItem";

        const t = row.type || "‚Äî";
        const time = row.at ? new Date(row.at).toLocaleString() : "‚Äî";
        const dh = row.delta_hours ?? 0;

        let line = "";
        if(t === "FEED") line = dh > 0 ? `–ü–æ–¥–∫–∏–Ω—É–ª–∏: +${dh}—á` : "–ü–æ–¥–∫–∏–Ω—É–ª–∏";
        else if(t === "EVENT") line = dh !== 0 ? `–°–æ–±—ã—Ç–∏–µ: ${dh>0?"+":""}${dh}—á` : "–°–æ–±—ã—Ç–∏–µ";
        else if(t === "CATASTROPHE") line = "–ö–∞—Ç–∞–∫–ª–∏–∑–º: –æ–≥–æ–Ω—å –ø–æ—Ç—É—Ö";
        else line = "–ó–∞–ø–∏—Å—å";

        const det = row.details ? `<div style="margin-top:6px;color:rgba(255,255,255,.80)">${row.details}</div>` : "";

        el.innerHTML = `
          <div class="logTop">
            <div class="logType">${t}</div>
            <div class="logTime">${time}</div>
          </div>
          <div class="logBody">
            ${line}<br/>
            ${row.remaining_before == null ? "" : `–î–æ: <b>${fmtHours(row.remaining_before)}</b> ‚Üí `}
            ${row.remaining_after == null ? "" : `–ü–æ—Å–ª–µ: <b>${fmtHours(row.remaining_after)}</b>`}
            ${det}
          </div>
        `;
        logBox.appendChild(el);
      }
    }

    async function loadEvents(){
      // –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ: —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∏–ª–∏ –ø–æ—Å—Ç-—Ç–µ–∫—Å—Ç
      const { data, error } = await sb
        .from("admin_events")
        .select("id,title,description,end_text,event_type,starts_at,ends_at,active,created_at")
        .order("created_at", { ascending:false })
        .limit(15);

      if(error){
        console.error("admin_events read error:", error);
        activeEvent = null;
        postEvent = null;
        return;
      }

      const now = Date.now();
      activeEvent = null;
      postEvent = null;

      for(const ev of (data || [])){
        const s = new Date(ev.starts_at).getTime();
        const e = new Date(ev.ends_at).getTime();

        if(s <= now && now <= e){
          activeEvent = ev;
          break;
        }

        // –ø–æ—Å—Ç-—Ç–µ–∫—Å—Ç 12 —á–∞—Å–æ–≤
        if(now > e && now <= (e + 12*3600*1000)){
          postEvent = ev;
          // –Ω–µ break ‚Äî –≤–¥—Ä—É–≥ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã—à–µ
        }
      }
    }

    function buildChart(){
      const canvas = document.getElementById("chart");
      if(!canvas) return;

      const old = Chart.getChart(canvas);
      if(old) old.destroy();

      const pts = (state.logs || [])
        .slice()
        .reverse()
        .filter(x => x.remaining_after != null && x.at != null)
        .map(x => ({ x: new Date(x.at), y: Number(x.remaining_after) }));

      chart = new Chart(canvas, {
        type: "line",
        data: {
          datasets: [{
            label: "–û—Å—Ç–∞–≤–∞–ª–æ—Å—å (—á–∞—Å—ã)",
            data: pts,
            tension: 0.25,
            pointRadius: 0,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          parsing: false,
          scales: {
            x: { type: "time" },
            y: { beginAtZero: true }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    function startTicker(){
      if(state.tickTimer) clearInterval(state.tickTimer);
      state.tickTimer = setInterval(()=>{
        render();
        renderEventUI();
      }, 1000);
    }

    async function refreshAll(){
      await loadFire();
      await loadProfile();
      await loadLogs();
      await loadEvents();
      buildChart();
      render();
      renderEventUI();
      startTicker();
    }

    // === Actions
    async function callFeed(use_item){
      try{
        lockActions(true);
        setStatus("–ó–∞–ø—Ä–æ—Å –∫ —è–¥—Ä—É‚Ä¶", "info");

        const { data, error } = await sb.rpc("feed_fire", { use_item });

        if(error){
          console.error(error);
          const msg = (error.message || "").toString();
          if(msg.includes("COOLDOWN")) setStatus("–ö—É–ª–¥–∞—É–Ω: –µ—â—ë —Ä–∞–Ω–æ.", "bad");
          else if(msg.includes("NO_COAL")) setStatus("–ù–µ—Ç —É–≥–ª—è.", "bad");
          else if(msg.includes("NO_FUEL")) setStatus("–ù–µ—Ç —Ç–æ–ø–ª–∏–≤–∞.", "bad");
          else if(msg.includes("NOT_AUTHENTICATED")) setStatus("–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏.", "bad");
          else setStatus("RPC –æ—à–∏–±–∫–∞: " + msg, "bad");
          return;
        }

        if(data?.fire) state.fire = data.fire;
        if(data?.profile) state.profile = data.profile;

        await refreshAll();
        setStatus("–ì–æ—Ç–æ–≤–æ. –ú–∏—Ä –æ—Ç–ª–æ–∂–µ–Ω –Ω–∞ –ø–æ—Ç–æ–º.", "ok");
      } finally {
        lockActions(false);
      }
    }

    btnRapid.addEventListener("click", async ()=>{
      if(!state.session) return;
      if(rapidLock) return;
      if(!activeEvent || activeEvent.event_type !== "rapid_click") return;

      rapidLock = true;
      setTimeout(()=> rapidLock = false, 150);

      const { error } = await sb.rpc("feed_rapid_click");
      if(error){
        console.error("feed_rapid_click:", error);
        return;
      }

      await loadFire();
      await loadLogs();
      buildChart();
      render();
      renderEventUI();
    });

    // === Auth
    btnLogin.addEventListener("click", async () => {
      setStatus("–û—Ç–∫—Ä—ã–≤–∞—é Discord‚Ä¶", "info");
      const { error } = await sb.auth.signInWithOAuth({
        provider: "discord",
        options: { redirectTo: SITE_URL }
      });
      if(error){ console.error(error); setStatus("–û—à–∏–±–∫–∞ Discord login.", "bad"); }
    });

    btnLogout.addEventListener("click", async () => {
      await sb.auth.signOut();
      state.session = null;
      state.profile = null;
      render();
    });

    // main buttons
    btnFire.addEventListener("click", ()=> callFeed("wood"));
    btnCoal.addEventListener("click", ()=> callFeed("coal"));
    btnFuel.addEventListener("click", ()=> callFeed("fuel"));
    btnRefresh.addEventListener("click", refreshAll);

    // admin modal open/close
    btnAdmin.addEventListener("click", ()=>{
      if(!checkAdmin()) return;
      adminHint.textContent = "–ù–∞—á–∞–ª–æ/–ö–æ–Ω–µ—Ü ‚Äî —ç—Ç–æ —Å—Ç–∞—Ä—Ç –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≤–µ–Ω—Ç–∞.";
      adminModal.style.display = "flex";
    });
    btnCloseAdmin.addEventListener("click", ()=> adminModal.style.display = "none");
    adminModal.addEventListener("click",(e)=>{ if(e.target === adminModal) adminModal.style.display="none"; });

    // create event
    btnCreateEvent.addEventListener("click", async ()=>{
      if(!checkAdmin()){
        adminHint.textContent = "–¢—ã –Ω–µ –∞–¥–º–∏–Ω (–∏–ª–∏ ADMIN_ID –Ω–µ —Ç–≤–æ–π user_id).";
        return;
      }

      const title = (evTitle.value || "").trim();
      const desc = (evDesc.value || "").trim();
      const endText = (evEndText.value || "").trim();
      const type = evType.value;

      if(!title || !desc || !endText){
        adminHint.textContent = "–ó–∞–ø–æ–ª–Ω–∏: –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è.";
        return;
      }
      if(!evStart.value || !evEnd.value){
        adminHint.textContent = "–í—ã–±–µ—Ä–∏ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü.";
        return;
      }

      const startsAt = new Date(evStart.value);
      const endsAt = new Date(evEnd.value);
      if(!(startsAt < endsAt)){
        adminHint.textContent = "–ö–æ–Ω–µ—Ü –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–∑–∂–µ –Ω–∞—á–∞–ª–∞.";
        return;
      }

      // –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø—É—Ç—å: RPC admin_start_event(...)
      // –ï—Å–ª–∏ —Ç—ã –µ—ë –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª ‚Äî —Å–∫–∞–∂–∏, –¥–∞–º SQL.
      const { data, error } = await sb.rpc("admin_start_event", {
        p_title: title,
        p_description: desc,
        p_end_text: endText,
        p_event_type: type,
        p_starts_at: startsAt.toISOString(),
        p_ends_at: endsAt.toISOString()
      });

      if(error){
        console.error("admin_start_event:", error);
        adminHint.textContent = "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: " + (error.message || "—Å–º. –∫–æ–Ω—Å–æ–ª—å");
        return;
      }

      adminHint.textContent = "–ò–≤–µ–Ω—Ç –∑–∞–ø—É—â–µ–Ω. id=" + (data?.id ?? "ok");
      await refreshAll();
    });

    // === init
    (async function init(){
      const { data } = await sb.auth.getSession();
      state.session = data.session || null;

      if(state.session) await ensureProfile();

      sb.auth.onAuthStateChange(async (_event, session) => {
        state.session = session;
        if(state.session) await ensureProfile();
        await refreshAll();
      });

      await refreshAll();
      setStatus("–ì–æ—Ç–æ–≤. –≠—Ç–æ –Ω–µ —Å–∞–π—Ç ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∂–∏–∑–Ω–µ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è.", "ok");
    })();
  </script>
</body>
</html>
